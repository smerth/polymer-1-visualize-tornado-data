<html><head><link rel="import" href="../polymer/polymer.html">

<script src="canvas-layer.js"></script>
<script src="shader-program.js"></script>


<script>Polymer({is:"point-overlay",properties:{map:{type:Object,value:null,observer:"_mapChanged"},overlay:{type:Object,value:null,readOnly:!0},vertexShader:{type:String,value:function(){return["// Uniforms: global values for all points in this draw call.","// point-overlay-provided uniforms","uniform mat4 _mapMatrix;","uniform float _resolutionScale;","// User-provided uniforms.","uniform float pointSize;","// Attributes: values associated with this point.","attribute vec4 _worldCoord;","// Varyings: Variables passed to fragment shader.","varying float pointWidth;","varying vec3 pointColor;","const vec3 baseColor = vec3(.9, .3, .1);","void main() {","  // Transform world coordinate to particular view based on the map position.","  gl_Position = _mapMatrix * _worldCoord;","  // Calculate point size, scaling by resolution multiplier of the screen.","  pointWidth = pointSize * _resolutionScale;","  gl_PointSize = pointWidth;","  // Pass pointColor to the fragment shader.","  pointColor = baseColor;","}"].join("\n")}},fragmentShader:{type:String,value:function(){return["precision mediump float;","const float filterPixelWidth = 1.4142135623730951;","// Varyings: Variables passed from the vertex shader.","varying float pointWidth;","varying vec3 pointColor;","void main() {","  // gl_PointCoord is the coordinate of the fragment (or pixel) this shader is","  // painting. Runs from 0 to 1, with (.5, .5) at the center of the point. Color","  // all points within .5 of the center, with some nice antialiasing added.","  float dist = length(gl_PointCoord - .5);","  float filterWidth = filterPixelWidth / pointWidth;","  float filtered = 1. - smoothstep(.5 - filterWidth, .5, dist);","  // Add an alpha blend to the color based on the filtered distance.","  gl_FragColor = vec4(pointColor, 1.) * filtered;","}"].join("\n")}},uniforms:{type:Object,readOnly:!0,value:function(){return{pointSize:32,pointAlpha:1}},notify:!0},data:{type:Array,value:null,notify:!0,observer:"_dataChanged"},running:{type:Boolean,value:!1,notify:!0,readOnly:!0}},observers:["_uniformsChanged(uniforms.*)","_shadersChanged(vertexShader, fragmentShader)"],scheduleUpdate:function(){if(!this.running){if(!this._pointProgram||!this._pointArrayBuffer)return;this.overlay.setUpdateHandler(this._update.bind(this)),this._setRunning(!0)}this.overlay.scheduleUpdate()},_resolutionScale:window.devicePixelRatio||1,_gl:null,_pointProgram:null,_pointArrayBuffer:null,_dataLayout:null,_pointCount:0,_pixelsToWebGLMatrix:null,_mapMatrix:null,_latToY:function(t){var e=-Math.log(Math.tan((.25+t/360)*Math.PI));return 128*(1+e/Math.PI)},_lngToX:function(t){return t>180?256*(t/360-.5):256*(t/360+.5)},_scaleMatrix:function(t,e,i){t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,t[4]*=i,t[5]*=i,t[6]*=i,t[7]*=i},_translateMatrix:function(t,e,i){t[12]+=t[0]*e+t[4]*i,t[13]+=t[1]*e+t[5]*i,t[14]+=t[2]*e+t[6]*i,t[15]+=t[3]*e+t[7]*i},_mapChanged:function(){this.map&&this.map instanceof google.maps.Map&&(window.CanvasLayer=createCanvasLayer(),this._setOverlay(new CanvasLayer({map:this.map,animate:!1,resizeHandler:this._resize.bind(this),resolutionScale:this._resolutionScale})),this._gl=this.overlay.canvas.getContext("webgl"),this._shadersChanged(),this._pixelsToWebGLMatrix=new Float32Array(16),this._mapMatrix=new Float32Array(16),this._dataChanged())},_dataChanged:function(){if(this._gl&&this.data){if(Array.isArray(this.data)&&0===this.data.length)return;var t=this.data,e=t[0],i={},a=0;i._worldCoord={length:2,byteOffset:0},a+=8;for(var r=Object.keys(e),n=0;n<r.length;n++){var o=r[n];if("lat"!==o&&"lng"!==o){var s,l=e[o];if("number"==typeof l)s=1;else{if(!Array.isArray(l)&&!ArrayBuffer.isView(l))continue;if(l.length<2||l.length>4){console.warn("attribute "+o+" has length "+l.length+", which is not supported. "+o+" will be skipped.");continue}s=l.length}i[o]={length:s,byteOffset:a},a+=4*s}}i._byteLength=a;var h=a/4;this._pointCount=t.length;var d=new Float32Array(this._pointCount*h);for(n=0;n<this._pointCount;n++){var u=t[n];d[n*h]=this._lngToX(u.lng),d[n*h+1]=this._latToY(u.lat);var f=2;for(var p in i)if(95!==p.charCodeAt(0)){var _=i[p];if(1===_.length)d[n*h+f]=u[p],f++;else for(var g=0;g<_.length;g++)d[n*h+f]=u[p][g],f++}}this._pointArrayBuffer=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._pointArrayBuffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,d,this._gl.STATIC_DRAW),this._dataLayout=i,this.scheduleUpdate()}},_debounceShadersChanged:function(){this.debounce("shadersChanged",this._shadersChanged)},_shadersChanged:function(){if(this.cancelDebouncer("shadersChanged"),this._gl){this._pointProgram||(this._pointProgram=new ShaderProgram(this._gl));var t,e=this.vertexShader,i=this.fragmentShader;t=/\.vert$/.test(e)||/\.glsl$/.test(e)?ShaderProgram.promiseXhr_(e):Promise.resolve(e);var a;a=/\.frag$/.test(i)||/\.glsl$/.test(i)?ShaderProgram.promiseXhr_(i):Promise.resolve(i);var r=this._pointProgram;Promise.all([t.then(r.setVertexShader.bind(r)),a.then(r.setFragmentShader.bind(r))]).then(function(){r.link(),this.scheduleUpdate()}.bind(this))}},_uniformsChanged:function(){this.overlay&&this.scheduleUpdate()},_resize:function(){var t=this.overlay.canvas,e=t.width,i=t.height,a=this._resolutionScale;this._gl.viewport(0,0,e,i),this._pixelsToWebGLMatrix.set([2*a/e,0,0,0,0,-2*a/i,0,0,0,0,0,0,-1,1,0,1])},_update:function(){var t=this._gl,e=this._pointProgram;e.use(),t.clear(t.COLOR_BUFFER_BIT),t.enable(this._gl.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA);var i=this.map,a=i.getProjection();this._mapMatrix.set(this._pixelsToWebGLMatrix);var r=Math.pow(2,i.getZoom());this._scaleMatrix(this._mapMatrix,r,r);var n=a.fromLatLngToPoint(this.overlay.getTopLeft());this._translateMatrix(this._mapMatrix,-n.x,-n.y);var o=this._dataLayout;for(var s in e.attributes){t.enableVertexAttribArray(e.attributes[s]),t.bindBuffer(t.ARRAY_BUFFER,this._pointArrayBuffer);var l=o[s];t.vertexAttribPointer(e.attributes[s],l.length,t.FLOAT,!1,o._byteLength,l.byteOffset)}var h=this.uniforms;for(var d in e.uniforms)95!==d.charCodeAt(0)&&e.uniforms[d](h[d]);e.uniforms._mapMatrix&&e.uniforms._mapMatrix(this._mapMatrix),e.uniforms._resolutionScale&&e.uniforms._resolutionScale(this._resolutionScale),t.drawArrays(t.POINTS,0,this._pointCount)}});</script>
</head><body></body></html>